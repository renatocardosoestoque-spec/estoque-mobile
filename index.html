<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Estoque Mobile</title>
    
    <!-- Configura√ß√µes PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4F46E5">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4F46E5;
            --primary-light: #818CF8;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --background: #F3F4F6;
            --surface: #ffffff;
            --text-main: #1F2937;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text-main);
        }

        body {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @supports (padding: max(0px)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            
            header {
                padding-top: max(1rem, env(safe-area-inset-top));
            }
        }

        /* Header */
        header {
            background: var(--surface);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-sm);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .header-title h1 {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .sync-status {
            position: absolute;
            top: 50%;
            right: 70px;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6B7280;
            transition: background 0.3s;
        }
        .sync-status.synced { background: #10B981; }
        .sync-status.pending { background: #F59E0B; animation: pulse 1.5s infinite; }
        .sync-status.error { background: #EF4444; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Main Content */
        #app-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
            padding-bottom: 80px;
        }

        /* Upload Screen */
        #upload-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem;
        }

        .upload-card {
            background: var(--surface);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 400px;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            width: 100%;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .file-input {
            display: none;
        }

        /* Search */
        .search-bar {
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--background);
            padding-bottom: 1rem;
        }

        .search-input-wrapper {
            position: relative;
            background: var(--surface);
            border-radius: 1rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
        }

        .search-input-wrapper i {
            color: var(--text-secondary);
            margin-right: 0.75rem;
        }

        .search-input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 1rem;
            color: var(--text-main);
            background: transparent;
        }

        /* Filters */
        .filters-scroll {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .filters-scroll::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            background: var(--surface);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Product List */
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .product-card {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .product-card:active {
            transform: scale(0.99);
            background: #f9fafb;
        }

        .product-info {
            flex: 1;
            min-width: 0;
        }

        .product-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stock-badge {
            background: var(--background);
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 3rem;
            text-align: center;
        }

        .stock-badge.low { color: var(--danger); background: #FEF2F2; }
        .stock-badge.medium { color: var(--warning); background: #FFFBEB; }
        .stock-badge.good { color: var(--secondary); background: #ECFDF5; }

        .indicator.adjusted {
            width: 4px;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            background: var(--primary);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: block;
            opacity: 1;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--surface);
            border-radius: 1.5rem 1.5rem 0 0;
            padding: 1.5rem;
            z-index: 101;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 1.5rem;
        }

        .sheet-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-main);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary);
        }

        .adj-type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .adj-option {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .adj-option.entrada.selected {
            background: #ECFDF5;
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .adj-option.saida.selected {
            background: #FEF2F2;
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 200;
            transition: transform 0.4s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { background: var(--secondary); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--primary); }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* FABs */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 90;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            font-size: 1.25rem;
            cursor: pointer;
            border: none;
            transition: transform 0.2s;
        }

        .fab:active {
            transform: scale(0.9);
        }

        .fab.secondary {
            background: white;
            color: var(--text-main);
            width: 48px;
            height: 48px;
            font-size: 1rem;
        }

        /* Badges */
        #pending-badge {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #EF4444;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header id="main-header" style="display:none;">
        <div class="header-title">
            <h1>Estoque Mobile</h1>
            <p id="header-subtitle">0 produtos</p>
        </div>
        <div id="header-actions">
            <div class="sync-status" id="sync-status-indicator"></div>
            <button onclick="updateScriptUrl()" style="background:none; border:none; color:var(--warning); cursor:pointer; font-size:1.2rem; margin-right: 10px;" title="Atualizar URL">
                <i class="fas fa-link"></i>
            </button>
            <button onclick="syncWithCloud()" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:1.2rem;" title="Sincronizar">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </header>

    <!-- Upload Screen -->
    <div id="upload-screen">
        <div class="upload-card">
            <div style="display:flex; justify-content:flex-end; width:100%; margin-bottom:-20px;">
                <button onclick="openConfig()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">
                    <i class="fas fa-cog" style="font-size:1.2rem;"></i>
                </button>
            </div>
            
            <i class="fas fa-cloud upload-icon"></i>
            <h2 style="margin-bottom: 0.5rem;" id="status-title">Carregar Estoque</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;" id="status-desc">Escolha uma op√ß√£o para come√ßar.</p>
            
            <button class="btn btn-primary" id="btn-cloud" onclick="syncWithCloud()" style="margin-bottom: 1rem; display: none;">
                <i class="fas fa-sync-alt"></i> Sincronizar com Nuvem
            </button>
            
            <label class="btn" style="background: var(--surface); border: 1px solid var(--border); color: var(--text-main);">
                <i class="fas fa-file-excel"></i> Carregar Arquivo Local
                <input type="file" id="file-input" class="file-input" accept=".xlsx, .xls">
            </label>
        </div>
    </div>

    <!-- Config Modal -->
    <div class="modal-overlay" id="config-overlay" onclick="closeConfig()"></div>
    <div class="bottom-sheet" id="config-sheet">
        <div class="sheet-handle"></div>
        <h3 class="sheet-title">Configura√ß√£o da Nuvem</h3>
        
        <div class="form-group">
            <label class="form-label">URL do Script Google</label>
            <input type="text" id="api-url" class="form-input" placeholder="https://script.google.com/macros/s/...">
            <p style="font-size:0.75rem; color:var(--text-secondary); margin-top:0.5rem;">
                Cole o link do Google Apps Script
            </p>
        </div>

        <button class="btn btn-primary" onclick="saveConfigAndClose()">
            <i class="fas fa-save"></i> Salvar e Conectar
        </button>
    </div>

    <!-- App Content -->
    <div id="app-content" style="display: none;">
        <div class="search-bar">
            <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Buscar produto...">
                <i class="fas fa-times" id="clear-search" style="display: none; margin-right: 0;" onclick="clearSearch()"></i>
            </div>
        </div>

        <div class="filters-scroll" id="category-filters">
            <div class="filter-chip active" onclick="filterByClass('')">Todos</div>
        </div>

        <div id="product-list" class="product-list"></div>
    </div>

    <!-- FABs -->
    <div class="fab-container" id="fabs" style="display: none;">
        <button class="fab secondary" onclick="generatePDF()" title="Exportar PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button class="fab secondary" onclick="syncPendingUpdates()" title="Sincronizar Pendentes" id="sync-pending-btn" style="display: none; background: #F59E0B; color: white;">
            <i class="fas fa-cloud-upload-alt"></i>
        </button>
        <button class="fab secondary" onclick="resetData()" title="Limpar Dados" style="background: #EF4444; color: white;">
            <i class="fas fa-trash"></i>
        </button>
        <button class="fab" onclick="showHistory()" title="Hist√≥rico">
            <i class="fas fa-history"></i>
        </button>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="edit-overlay" onclick="closeModal()"></div>
    <div class="bottom-sheet" id="edit-sheet">
        <div class="sheet-handle"></div>
        <h3 class="sheet-title" id="modal-product-title">Ajustar Estoque</h3>
        
        <input type="hidden" id="modal-index">
        
        <div class="form-group">
            <label class="form-label">Estoque Atual</label>
            <input type="number" id="modal-current-stock" class="form-input" readonly style="background: #f3f4f6;">
        </div>

        <div class="form-group">
            <label class="form-label">Estoque F√≠sico</label>
            <input type="number" id="modal-physical-stock" class="form-input" placeholder="Digite o valor contado" inputmode="numeric">
        </div>

        <div class="adj-type-selector">
            <div class="adj-option entrada" id="opt-entrada">
                <i class="fas fa-arrow-up"></i> Entrada
            </div>
            <div class="adj-option saida" id="opt-saida">
                <i class="fas fa-arrow-down"></i> Sa√≠da
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Diferen√ßa</label>
            <input type="text" id="modal-diff" class="form-input" readonly style="font-weight: bold;">
        </div>

        <button class="btn btn-primary" onclick="confirmAdjustment()">
            <i class="fas fa-check"></i> Confirmar Ajuste
        </button>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="history-overlay" onclick="closeHistory()"></div>
    <div class="bottom-sheet" id="history-sheet" style="height: 80vh;">
        <div class="sheet-handle"></div>
        <h3 class="sheet-title">Hist√≥rico de Ajustes</h3>
        <div id="history-list" style="overflow-y: auto; max-height: 60vh;"></div>
        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="closeHistory()">
            <i class="fas fa-times"></i> Fechar
        </button>
    </div>

    <!-- Loading & Toast -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 500;">Processando...</p>
    </div>
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i> <span>Mensagem</span>
    </div>

    <!-- Badge -->
    <div id="pending-badge"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- App Logic -->
    <script>
        // State
        let stockData = [];
        let classifications = new Set();
        let currentFilter = '';
        let adjustmentType = 'saida';
        let apiUrl = localStorage.getItem('googleScriptUrl') || '';

        // DOM Elements
        const appContent = document.getElementById('app-content');
        const uploadScreen = document.getElementById('upload-screen');
        const fileInput = document.getElementById('file-input');
        const productList = document.getElementById('product-list');
        const loadingOverlay = document.getElementById('loading-overlay');
        const toast = document.getElementById('toast');
        const btnCloud = document.getElementById('btn-cloud');
        const modalPhysical = document.getElementById('modal-physical-stock');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (apiUrl) {
                document.getElementById('api-url').value = apiUrl;
                btnCloud.style.display = 'flex';
                document.getElementById('status-title').innerText = 'Conectado √† Nuvem';
                document.getElementById('status-desc').innerText = 'Toque em Sincronizar para atualizar.';
            }
            loadFromLocal();
            updatePendingBadge();
            updateSyncIndicator();
        });

        // ===== CONFIG FUNCTIONS =====
        function openConfig() {
            document.getElementById('config-overlay').classList.add('active');
            document.getElementById('config-sheet').classList.add('active');
            document.getElementById('api-url').value = apiUrl;
        }

        function closeConfig() {
            document.getElementById('config-overlay').classList.remove('active');
            document.getElementById('config-sheet').classList.remove('active');
        }

        function saveConfig() {
            const url = document.getElementById('api-url').value.trim();
            if (url) {
                localStorage.setItem('googleScriptUrl', url);
                apiUrl = url;
                showToast('Configura√ß√£o salva!', 'success');
            }
        }

        function saveConfigAndClose() {
            saveConfig();
            closeConfig();
            if (apiUrl) {
                btnCloud.style.display = 'flex';
                document.getElementById('status-title').innerText = 'Conectado √† Nuvem';
                document.getElementById('status-desc').innerText = 'Toque em Sincronizar para atualizar.';
                showToast('Configura√ß√£o salva! Pronto para sincronizar.', 'success');
            }
        }

        function updateScriptUrl() {
            const newUrl = prompt('Cole a NOVA URL do Google Apps Script:', apiUrl || 'https://script.google.com/macros/s/...');
            if (newUrl && newUrl.includes('script.google.com')) {
                localStorage.setItem('googleScriptUrl', newUrl);
                apiUrl = newUrl;
                document.getElementById('api-url').value = newUrl;
                showToast('URL atualizada!', 'success');
                
                if (stockData.length > 0) {
                    setTimeout(() => syncWithCloud(), 500);
                }
            }
        }

        // ===== SYNC FUNCTIONS =====
        function updateSyncIndicator(status = '') {
            const indicator = document.getElementById('sync-status-indicator');
            if (!indicator) return;
            
            if (status === 'syncing') {
                indicator.className = 'sync-status pending';
            } else if (status === 'success') {
                indicator.className = 'sync-status synced';
                setTimeout(() => updateSyncIndicator(''), 3000);
            } else if (status === 'error') {
                indicator.className = 'sync-status error';
                setTimeout(() => updateSyncIndicator(''), 5000);
            } else {
                indicator.className = 'sync-status';
            }
        }

        async function updateCloudStock(rowIndex, newStock, productName) {
            const item = stockData.find(p => p.id === rowIndex);
            const prodName = productName || (item ? item.product : 'Produto ' + rowIndex);
            
            try {
                showToast('üì§ Enviando para planilha...', 'info');
                updateSyncIndicator('syncing');
                
                const payload = {
                    action: 'update',
                    product: prodName,
                    newStock: newStock,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showToast('‚úÖ Planilha atualizada!', 'success');
                    updateSyncIndicator('success');
                } else {
                    throw new Error(result.message);
                }
                
            } catch (e) {
                console.error('Erro:', e);
                showToast('‚ö†Ô∏è Salvo localmente', 'warning');
                updateSyncIndicator('error');
                savePendingUpdate(rowIndex, newStock, prodName);
            }
        }

        function savePendingUpdate(rowIndex, newStock, productName) {
            let pending = JSON.parse(localStorage.getItem('pendingUpdates') || '[]');
            pending.push({
                rowIndex: rowIndex,
                newStock: newStock,
                product: productName,
                timestamp: new Date().getTime()
            });
            localStorage.setItem('pendingUpdates', JSON.stringify(pending));
            updatePendingBadge();
        }

        function updatePendingBadge() {
            const pending = JSON.parse(localStorage.getItem('pendingUpdates') || '[]');
            const badge = document.getElementById('pending-badge');
            const syncBtn = document.getElementById('sync-pending-btn');
            
            if (pending.length > 0) {
                badge.textContent = pending.length;
                badge.style.display = 'flex';
                if (syncBtn) syncBtn.style.display = 'flex';
            } else {
                badge.style.display = 'none';
                if (syncBtn) syncBtn.style.display = 'none';
            }
        }

        async function syncPendingUpdates() {
            const pending = JSON.parse(localStorage.getItem('pendingUpdates') || '[]');
            if (pending.length === 0) return;
            
            showToast(`üîÑ Enviando ${pending.length} pendentes...`, 'info');
            updateSyncIndicator('syncing');
            
            for (const update of [...pending]) {
                try {
                    await updateCloudStock(update.rowIndex, update.newStock, update.product);
                } catch (e) {
                    console.log('Pendente falhou:', e);
                }
            }
            
            const newPending = pending.filter(p => !p.synced);
            localStorage.setItem('pendingUpdates', JSON.stringify(newPending));
            updatePendingBadge();
            updateSyncIndicator('success');
        }

        // ===== MAIN FUNCTIONS =====
        async function syncWithCloud() {
            if (!apiUrl) {
                openConfig();
                return;
            }

            showLoading(true);
            showToast('Conectando com nuvem...', 'info');
            updateSyncIndicator('syncing');
            
            try {
                const urlWithCacheBuster = apiUrl + (apiUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                const response = await fetch(urlWithCacheBuster, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {'Accept': 'application/json'}
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const text = await response.text();
                let json;
                
                try {
                    json = JSON.parse(text);
                } catch (e) {
                    const match = text.match(/callback\((.+)\)/);
                    json = match ? JSON.parse(match[1]) : {status: 'error', message: 'Resposta inv√°lida'};
                }
                
                if (json.status === 'error') throw new Error(json.message);
                
                const success = processCloudData(json.data || json);
                
                if (success) {
                    showToast('Sincronizado com sucesso!', 'success');
                    updateSyncIndicator('success');
                    setTimeout(syncPendingUpdates, 1000);
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro: ' + error.message, 'error');
                updateSyncIndicator('error');
            } finally {
                showLoading(false);
            }
        }

        function processCloudData(data) {
            try {
                stockData = [];
                classifications.clear();
                
                if (!data || !Array.isArray(data)) {
                    showToast('Dados inv√°lidos da nuvem', 'error');
                    return false;
                }
                
                if (Array.isArray(data[0])) {
                    let idxProd = -1, idxClass = -1, idxStock = -1;
                    
                    for (let i = 0; i < Math.min(5, data.length); i++) {
                        const row = data[i].map(c => String(c).toLowerCase());
                        if (idxProd === -1) idxProd = row.findIndex(c => c.includes('produto') || c.includes('descri'));
                        if (idxStock === -1) idxStock = row.findIndex(c => c.includes('estoque') || c.includes('quant'));
                        if (idxClass === -1) idxClass = row.findIndex(c => c.includes('class') || c.includes('categ'));
                        
                        if (idxProd !== -1 && idxStock !== -1) {
                            for (let j = i + 1; j < data.length; j++) {
                                addProductFromRow(data[j], idxProd, idxClass, idxStock, j);
                            }
                            break;
                        }
                    }
                } else {
                    data.forEach((item, index) => addProductFromObject(item, index));
                }
                
                if (stockData.length === 0) {
                    showToast('Nenhum produto encontrado', 'error');
                    return false;
                }
                
                stockData.sort((a, b) => a.product.localeCompare(b.product));
                
                uploadScreen.style.display = 'none';
                document.getElementById('main-header').style.display = 'flex';
                appContent.style.display = 'block';
                document.getElementById('fabs').style.display = 'flex';
                
                saveToLocal();
                renderFilters();
                renderList();
                updateSubtitle();
                
                return true;
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao processar dados', 'error');
                return false;
            }
        }

        function addProductFromRow(row, idxProd, idxClass, idxStock, id) {
            if (!row || row.length <= idxProd) return;
            
            const product = String(row[idxProd] || '').trim();
            if (!product || product.match(/total|soma|^$/i)) return;
            
            const classification = idxClass > -1 ? String(row[idxClass] || 'GERAL').toUpperCase() : 'GERAL';
            
            let rawStock = idxStock > -1 ? row[idxStock] : 0;
            let stock = 0;
            
            if (typeof rawStock === 'number') {
                stock = Math.floor(rawStock);
            } else if (typeof rawStock === 'string') {
                stock = parseInt(rawStock.replace(/[^\d.,-]/g, '')) || 0;
            }
            
            stock = Math.max(0, stock);
            
            stockData.push({
                id: id,
                product: product.toUpperCase(),
                classification: classification,
                originalStock: stock,
                stock: stock,
                adjustments: []
            });
            
            classifications.add(classification);
        }

        function addProductFromObject(obj, id) {
            const product = String(obj.produto || obj.product || obj.descricao || '').trim();
            if (!product) return;
            
            const classification = String(obj.classificacao || obj.category || obj.categoria || 'GERAL').toUpperCase();
            const stock = Math.max(0, parseInt(obj.estoque || obj.stock || obj.quantidade || 0));
            
            stockData.push({
                id: id,
                product: product.toUpperCase(),
                classification: classification,
                originalStock: stock,
                stock: stock,
                adjustments: []
            });
            
            classifications.add(classification);
        }

        // ===== FILE UPLOAD =====
        fileInput.addEventListener('change', loadExcelData);

        function loadExcelData() {
            if (!fileInput.files.length) return;
            
            showLoading(true);
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    processData(workbook);
                    
                    uploadScreen.style.display = 'none';
                    document.getElementById('main-header').style.display = 'flex';
                    appContent.style.display = 'block';
                    document.getElementById('fabs').style.display = 'flex';
                    
                    saveToLocal();
                    showToast(`${stockData.length} produtos carregados!`, 'success');
                } catch (error) {
                    console.error(error);
                    showToast('Erro ao ler arquivo', 'error');
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(workbook) {
            stockData = [];
            classifications.clear();
            
            let sheetName = workbook.SheetNames.find(n => n.match(/balan√ßo|base|estoque/i)) || workbook.SheetNames[0];
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, defval: '' });
            
            let headerRow = 0;
            for (let i = 0; i < Math.min(20, json.length); i++) {
                const row = json[i].map(c => String(c).toLowerCase());
                if (row.some(c => c.includes('produto')) && row.some(c => c.includes('estoque'))) {
                    headerRow = i;
                    break;
                }
            }

            for (let i = headerRow + 1; i < json.length; i++) {
                const row = json[i];
                if (!row || row.length < 2) continue;
                
                const rawClass = row[1] ? String(row[1]).trim().toUpperCase() : 'GERAL';
                const product = row[2] ? String(row[2]).trim() : String(row[0] || '').trim();
                let stock = row[3] !== undefined ? row[3] : (row[1] !== undefined ? row[1] : 0);
                
                if (!product || product.match(/total|^$/i)) continue;
                
                if (typeof stock === 'string') {
                    stock = parseInt(stock.replace(/[^\d.,-]/g, '')) || 0;
                }
                stock = Math.max(0, Math.floor(Number(stock) || 0));
                
                const classification = rawClass || 'GERAL';
                
                stockData.push({
                    id: i,
                    product: product.toUpperCase(),
                    classification: classification,
                    originalStock: stock,
                    stock: stock,
                    adjustments: []
                });
                
                classifications.add(classification);
            }
            
            stockData.sort((a, b) => a.product.localeCompare(b.product));
            
            renderFilters();
            renderList();
            updateSubtitle();
        }

        // ===== UI FUNCTIONS =====
        function renderFilters() {
            const container = document.getElementById('category-filters');
            let html = '<div class="filter-chip active" onclick="filterByClass(\'\', this)">Todos</div>';
            
            Array.from(classifications).sort().forEach(c => {
                html += `<div class="filter-chip" onclick="filterByClass('${c}', this)">${c}</div>`;
            });
            container.innerHTML = html;
        }

        function filterByClass(cls, el) {
            currentFilter = cls;
            
            if (el) {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
            }
            
            renderList(document.getElementById('search-input').value);
        }

        function renderList(search = '') {
            search = search.toLowerCase();
            const filtered = stockData.filter(item => {
                const matchSearch = item.product.toLowerCase().includes(search);
                const matchClass = currentFilter ? item.classification === currentFilter : true;
                return matchSearch && matchClass;
            });

            if (filtered.length === 0) {
                productList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Nenhum produto encontrado</p>
                    </div>`;
                return;
            }

            let html = '';
            filtered.forEach(item => {
                const stockClass = item.stock < 5 ? 'low' : (item.stock < 10 ? 'medium' : 'good');
                const hasAdj = item.adjustments.length > 0;
                
                html += `
                <div class="product-card" onclick="openEdit(${stockData.indexOf(item)})">
                    ${hasAdj ? '<div class="indicator adjusted"></div>' : ''}
                    <div class="product-info">
                        <div class="product-name">${item.product}</div>
                        <div class="product-meta">
                            <span>${item.classification}</span>
                            ${hasAdj ? '<span style="color:var(--primary); font-size:0.75rem;"><i class="fas fa-pen"></i> Editado</span>' : ''}
                        </div>
                    </div>
                    <div class="stock-badge ${stockClass}">${item.stock}</div>
                </div>`;
            });
            
            productList.innerHTML = html;
        }

        // ===== EDIT FUNCTIONS =====
        function openEdit(index) {
            const item = stockData[index];
            document.getElementById('modal-index').value = index;
            document.getElementById('modal-product-title').innerText = item.product;
            document.getElementById('modal-current-stock').value = item.stock;
            document.getElementById('modal-physical-stock').value = '';
            document.getElementById('modal-diff').value = '-';
            
            document.getElementById('opt-entrada').classList.remove('selected');
            document.getElementById('opt-saida').classList.remove('selected');
            
            document.getElementById('edit-overlay').classList.add('active');
            document.getElementById('edit-sheet').classList.add('active');
            
            setTimeout(() => modalPhysical.focus(), 300);
        }

        modalPhysical.addEventListener('input', calculateDiff);

        function calculateDiff() {
            const current = parseInt(document.getElementById('modal-current-stock').value) || 0;
            const physical = parseInt(modalPhysical.value);
            const diffEl = document.getElementById('modal-diff');
            
            const entradaBtn = document.getElementById('opt-entrada');
            const saidaBtn = document.getElementById('opt-saida');
            
            if (isNaN(physical)) {
                diffEl.value = '-';
                entradaBtn.classList.remove('selected');
                saidaBtn.classList.remove('selected');
                return;
            }
            
            const diff = physical - current;
            
            if (diff > 0) {
                adjustmentType = 'entrada';
                entradaBtn.classList.add('selected');
                saidaBtn.classList.remove('selected');
                diffEl.value = `+${diff} (Entrada)`;
                diffEl.style.color = 'var(--secondary)';
            } else if (diff < 0) {
                adjustmentType = 'saida';
                saidaBtn.classList.add('selected');
                entradaBtn.classList.remove('selected');
                diffEl.value = `${diff} (Sa√≠da)`;
                diffEl.style.color = 'var(--danger)';
            } else {
                diffEl.value = 'Sem altera√ß√£o';
                diffEl.style.color = 'var(--text-secondary)';
                entradaBtn.classList.remove('selected');
                saidaBtn.classList.remove('selected');
            }
        }

        function confirmAdjustment() {
            const index = document.getElementById('modal-index').value;
            const item = stockData[index];
            const physical = parseInt(modalPhysical.value);
            
            if (isNaN(physical)) {
                showToast('Digite um valor v√°lido', 'error');
                return;
            }
            
            const diff = physical - item.stock;
            if (diff !== 0) {
                item.stock = physical;
                item.adjustments.push({
                    date: new Date(),
                    type: diff > 0 ? 'Entrada' : 'Sa√≠da',
                    qty: Math.abs(diff),
                    final: physical
                });
                showToast('Estoque atualizado!', 'success');
                saveToLocal();
                
                if (apiUrl) {
                    setTimeout(() => updateCloudStock(item.id, physical, item.product), 10);
                }
            }
            
            closeModal();
            renderList(document.getElementById('search-input').value);
            updateSubtitle();
        }

        function closeModal() {
            document.getElementById('edit-overlay').classList.remove('active');
            document.getElementById('edit-sheet').classList.remove('active');
        }

        // ===== HISTORY & PDF =====
        function showHistory() {
            const historyList = document.getElementById('history-list');
            const adjusted = stockData.filter(i => i.adjustments.length > 0);
            
            if (adjusted.length === 0) {
                historyList.innerHTML = '<p style="text-align:center; padding:2rem; color:var(--text-secondary);">Nenhum ajuste realizado.</p>';
            } else {
                let html = '';
                adjusted.forEach(item => {
                    item.adjustments.forEach(adj => {
                        html += `
                        <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
                            <div style="font-weight:600;">${item.product}</div>
                            <div style="display:flex; justify-content:space-between; margin-top:0.5rem; font-size:0.9rem;">
                                <span style="color:${adj.type === 'Entrada' ? 'var(--secondary)' : 'var(--danger)'}">
                                    ${adj.type === 'Entrada' ? '+' : '-'}${adj.qty}
                                </span>
                                <span style="color:var(--text-secondary);">
                                    ${adj.date.toLocaleTimeString().slice(0,5)}
                                </span>
                            </div>
                        </div>`;
                    });
                });
                historyList.innerHTML = html;
            }
            
            document.getElementById('history-overlay').classList.add('active');
            document.getElementById('history-sheet').classList.add('active');
        }

        function closeHistory() {
            document.getElementById('history-overlay').classList.remove('active');
            document.getElementById('history-sheet').classList.remove('active');
        }

        // ===== UTILS =====
        function saveToLocal() {
            try {
                const dataToSave = {
                    stockData: stockData,
                    classifications: Array.from(classifications),
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('estoqueData', JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Erro ao salvar localmente", e);
            }
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('estoqueData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    stockData = parsed.stockData;
                    stockData.forEach(item => {
                        item.adjustments.forEach(adj => {
                            adj.date = new Date(adj.date);
                        });
                    });
                    
                    classifications = new Set(parsed.classifications);
                    
                    uploadScreen.style.display = 'none';
                    document.getElementById('main-header').style.display = 'flex';
                    appContent.style.display = 'block';
                    document.getElementById('fabs').style.display = 'flex';
                    
                    renderFilters();
                    renderList();
                    updateSubtitle();
                } catch (e) {
                    console.error("Erro ao carregar dados", e);
                    localStorage.removeItem('estoqueData');
                }
            }
        }

        function resetData() {
            if (confirm('Tem certeza? Isso apagar√° todos os dados atuais.')) {
                localStorage.removeItem('estoqueData');
                localStorage.removeItem('pendingUpdates');
                location.reload();
            }
        }

        function updateSubtitle() {
            document.getElementById('header-subtitle').innerText = `${stockData.length} produtos totais`;
        }

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        function showToast(msg, type = 'success') {
            toast.querySelector('span').innerText = msg;
            toast.className = `toast ${type} show`;
            
            const icon = toast.querySelector('i');
            if (type === 'success') icon.className = 'fas fa-check-circle';
            else if (type === 'error') icon.className = 'fas fa-exclamation-circle';
            else if (type === 'warning') icon.className = 'fas fa-exclamation-triangle';
            else icon.className = 'fas fa-info-circle';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            document.getElementById('clear-search').style.display = val ? 'block' : 'none';
            renderList(val);
        });

        function clearSearch() {
            const input = document.getElementById('search-input');
            input.value = '';
            input.focus();
            document.getElementById('clear-search').style.display = 'none';
            renderList();
        }

        // Auto-sync when online
        window.addEventListener('online', () => {
            showToast('üåê Conectado - sincronizando...', 'success');
            syncPendingUpdates();
        });

        // Auto-sync every 30 seconds
        setInterval(() => {
            if (navigator.onLine && apiUrl) {
                syncPendingUpdates();
            }
        }, 30000);
    </script>
</body>
</html>
